# Probo Deployment Guide

This guide covers deploying the Probo application to Railway using Docker containerization.

## üöÄ Quick Start

### Prerequisites
- Railway CLI installed (`npm install -g @railway/cli`)
- Docker (optional, for local testing)
- Git repository connected to Railway

### Deploy to Railway

1. **Login to Railway**
   ```bash
   railway login
   ```

2. **Create a new Railway project**
   ```bash
   railway init
   ```

3. **Add PostgreSQL database**
   ```bash
   railway add --database postgres
   ```

4. **Set environment variables**
   
   **Option A: Using Railway Dashboard (Recommended)**
   - Go to your project at https://railway.com/project/your-project-id
   - Click on "Variables" tab
   - Add the following variables:
   
   ```
   OPENAI_API_KEY=your-openai-key-here
   SESSION_SECRET=your-long-random-string-here
   APP_URL=https://your-app.railway.app
   S3_BUCKET=probod
   ```
   
   **Option B: Using Railway CLI (if available in your version)**
   ```bash
   # Check Railway CLI help for current syntax
   railway variables --help
   
   # Example (syntax may vary by CLI version):
   railway env set OPENAI_API_KEY="your-openai-key"
   railway env set SESSION_SECRET="$(openssl rand -base64 32)"
   railway env set APP_URL="https://your-app.railway.app"
   railway env set S3_BUCKET="probod"
   ```

5. **Deploy**
   ```bash
   railway up
   ```

## üìã Environment Variables

### Required Variables
```env
DATABASE_URL=postgresql://...          # Auto-generated by Railway
OPENAI_API_KEY=sk-...                 # Your OpenAI API key
SESSION_SECRET=long-random-string      # Generate with: openssl rand -base64 32
APP_URL=https://your-app.railway.app   # Your app's URL
```

### Optional Variables
```env
# S3/MinIO Storage (defaults to Railway volumes)
S3_ENDPOINT=https://s3.amazonaws.com
S3_ACCESS_KEY_ID=your-access-key
S3_SECRET_ACCESS_KEY=your-secret-key
S3_BUCKET=probod
AWS_REGION=us-east-1

# Email Configuration
MAILER_FROM_EMAIL=noreply@getprobo.com
MAILER_FROM_NAME=Probo
MAILER_SMTP_HOST=smtp.sendgrid.net
MAILER_SMTP_PORT=587
MAILER_SMTP_USERNAME=apikey
MAILER_SMTP_PASSWORD=your-sendgrid-api-key

# Performance Tuning
DB_MAX_CONNECTIONS=20
DB_MAX_IDLE_CONNECTIONS=5
RATE_LIMIT_RPM=100
UPLOAD_MAX_SIZE=10485760

# Logging
LOG_LEVEL=info
```

## üê≥ Docker Files Overview

### Production Deployment Options

1. **`Dockerfile.production`** - Complete single-container deployment
   - Combines frontend and backend in one container
   - Uses supervisor to manage both processes
   - Best for simple deployments

2. **`Dockerfile.backend`** - Backend-only container
   - Optimized Go service container (~20MB)
   - Best for microservice architecture

3. **`Dockerfile.frontend`** - Frontend-only container  
   - Nginx serving React app (~50MB)
   - Best for CDN or separate frontend service

### Build Commands

```bash
# Build combined container
docker build -f Dockerfile.production -t probo:latest .

# Build separate containers
docker build -f Dockerfile.backend -t probo-backend:latest .
docker build -f Dockerfile.frontend -t probo-frontend:latest .
```

## üóÑÔ∏è Database Migrations

Migrations run automatically on deployment via the `scripts/migrate.sh` script.

### Manual Migration
```bash
# Connect to Railway database
railway connect postgresql

# Run migrations manually
railway run ./scripts/migrate.sh
```

## üîß Configuration Files

### `cfg/production.yaml`
Production configuration with environment variable substitution.

### `railway.json`
Railway-specific deployment configuration:
- Build settings
- Health checks
- Volume mounts
- Service definitions

### `nginx.conf`
Nginx configuration for frontend serving:
- SPA routing support
- API proxying to backend
- Security headers
- Gzip compression
- Rate limiting

## üîí Security Features

- Non-root user execution
- Security headers (CSP, HSTS, etc.)
- Rate limiting on API endpoints
- Secure session configuration
- CORS protection

## üìä Monitoring & Health Checks

- Health check endpoint: `/api/health`
- Nginx access logs
- Application logs via supervisor
- Railway built-in metrics

## üö® Troubleshooting

### Check Logs
```bash
# Railway logs
railway logs

# Local container logs
docker logs <container-id>
```

### Common Issues

1. **Database Connection Issues**
   - Verify `DATABASE_URL` is set correctly
   - Check Railway PostgreSQL addon status

2. **Build Failures**
   - Check `.dockerignore` excludes unnecessary files
   - Verify all dependencies are included in package.json

3. **Static Asset Issues**
   - Check nginx configuration
   - Verify frontend build completed successfully

### Database Troubleshooting
```bash
# Test database connection
railway run psql $DATABASE_URL -c "SELECT version();"

# Check migration status
railway run psql $DATABASE_URL -c "SELECT * FROM schema_migrations ORDER BY applied_at DESC LIMIT 5;"
```

## üîÑ Development vs Production

### Development
- Uses `compose.yaml` with all services
- Hot reloading enabled
- Development database and S3

### Production
- Single container deployment
- Environment-based configuration
- Managed database and storage
- Security headers enabled

## üìà Scaling

### Horizontal Scaling
- Railway auto-scaling based on CPU/memory
- Database connection pooling configured
- Stateless application design

### Performance Optimization
- Docker layer caching
- Nginx static asset caching
- Gzip compression
- Database connection pooling

## üåç Custom Domain

1. Add custom domain in Railway dashboard
2. Update `APP_URL` environment variable
3. Configure DNS records
4. SSL certificates handled automatically by Railway

## üí∞ Cost Optimization

- Use Railway's free tier for development
- Production: ~$5-20/month depending on usage
- PostgreSQL: Included in Railway Pro plan
- Consider external S3 for large file storage

## üìö Additional Resources

- [Railway Documentation](https://docs.railway.app/)
- [Docker Best Practices](https://docs.docker.com/develop/best-practices/)
- [Nginx Configuration Guide](https://nginx.org/en/docs/)

---

## üéØ Quick Commands Reference

```bash
# Deploy to Railway
railway up

# Check status
railway status

# View logs
railway logs

# Connect to database
railway connect postgres

# Set environment variables (check CLI version for exact syntax)
# Use Railway Dashboard or check: railway variables --help

# Local development
make dev

# Build for production
make build

# Run tests
make test
```